<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Time Seconds Event Caught 10 times</title>
  <meta name="description" content="A test of a timer throwing timer eventts in 10 seconds">
  <meta name="author" content="Steve Browning">

  <link rel="stylesheet" href="css/styles.css?v=1.0">
</head>

<body>
  <h2 class="green">Assert - Timer fires 10 seconds events that are caught and then remotely stops the timer</h2>
  <div id="status"></div>
  <div id="desc"></div>

  <script type="module">
    const channel = new BroadcastChannel('channel');
    const index = new BroadcastChannel('index');
    const controls = new BroadcastChannel('controls')
    // get the status dom node
    const status = document.getElementById('status');
    const worker = new Worker("./TimerWorker.js", { type: "module" });

    assertTimerEventsAreSentAsABroadcastEvent();
    const bar = document.querySelector('#status')
    bar.style.width = 0;
    function pass(assertionSent) {
      // set up the status
      status.innerHTML = '<p></p>';
      // verify the data
      status.style.color = 'white'
      // style the status box and text to Pass
      status.style.backgroundColor = 'green'

      status.innerHTML = '<p>PASS - timer killed</p>';
      if (assertionSent == 0) {
        index.postMessage({
          title: 'Assert - Timer Event is passed via the channel and counts to 10', status: 'pass', html: `The timer count reach 10 seconds and was 
                passed via the broadcast channel.`});
        console.log('Pass')
      }
    }
    function fail(assertionSent) {
      if (assertionSent == 0) {
        // style the status box and text to Fail
        status.style.backgroundColor = 'red'
        status.innerHTML = '<p>FAIL</p>';
        index.postMessage({
          title: 'Assert - Timer event is passed and saved in LocalStorage', status: 'fail', html: `<p>The payload <code>{mock: 15}</code> was 
              was not passed. It did not store this in localstorage.</p>`});
        console.log('Fail')
      }
    }
    function assertTimerEventsAreSentAsABroadcastEvent() {
      // Set up the Timer Worker.

      let count = 0;
      let assertionSent = 0;
      channel.onmessage = (event) => {
        if (event.data.countBy == 1) {
          count++;
          // don't calculate based on 10% for each bar increment, 
          // instead use 9.1 as the count actually goes to 11 and 
          // makes the bar overflow.
          bar.style.width = count * 9.1 + '%';
         
          if (count > 10) {
            assertionSent = 1;
            controls.postMessage({'msg': 'kill-timer'})
            if(count == 10) {
              bar.innerHTML = '<p>PASS  - killed timer</p>'
            }
          }
        }
        
        if (count <= 10) {
          bar.style.color = 'white';
          bar.innerHTML = `<p>PROCESSING... ${count} event fired</p>`
          if (count == 10) {
            pass(assertionSent);
          }
        } else {
          fail(assertionSent);
        }

        
      }
    }


  </script>
</body>

</html>